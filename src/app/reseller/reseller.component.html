<div *ngIf="reseller">
  <h1 *ngIf="isOwner; else otherTitle">Benvenuto {{ reseller.username }}</h1>
  <ng-template #otherTitle>
    <h1>Informazioni del rivenditore</h1>
  </ng-template>

  <div class="row">
    <!-- Colonna sinistra: Avatar e pulsante modifica foto (visibile solo se è il proprietario e in modalità edit) -->
    <div class="col-md-4 text-center">
      <img
        [src]="imgUrl + reseller.avatar"
        alt="Avatar"
        class="img-fluid rounded mb-2"
      />
      <div *ngIf="isOwner && editMode">
        <button class="btn btn-outline-primary" (click)="fileInput.click()">
          Modifica foto
        </button>
        <input
          type="file"
          #fileInput
          style="display: none"
          (change)="onAvatarSelected($event)"
        />
      </div>
      <div class="mt-3">
        <p>
          <strong>Rating medio:</strong>
          {{ reseller.ratingMedio | number : "1.1-1" }} / 5
        </p>
      </div>
    </div>

    <!-- Colonna destra: Form unificato (i campi hanno [readonly]="!editMode") -->
    <div class="col-md-8">
      <form [formGroup]="resellerForm" (ngSubmit)="onSubmit()">
        <!-- Email -->
        <div class="form-group">
          <label>Email:</label>
          <input
            type="email"
            formControlName="email"
            class="form-control"
            [readonly]="!editMode"
          />
        </div>

        <!-- Nome -->
        <div class="form-group">
          <label>Nome:</label>
          <input
            type="text"
            formControlName="name"
            class="form-control"
            [readonly]="!editMode"
          />
        </div>

        <!-- Cognome -->
        <div class="form-group">
          <label>Cognome:</label>
          <input
            type="text"
            formControlName="surname"
            class="form-control"
            [readonly]="!editMode"
          />
        </div>

        <!-- Telefono -->
        <div class="form-group">
          <label>Telefono:</label>
          <input
            type="text"
            formControlName="phoneNumber"
            class="form-control"
            [readonly]="!editMode"
          />
        </div>

        <!-- Ragione Sociale -->
        <div class="form-group">
          <label>Ragione Sociale:</label>
          <input
            type="text"
            formControlName="ragioneSociale"
            class="form-control"
            [readonly]="!editMode"
          />
        </div>

        <!-- Partita IVA -->
        <div class="form-group">
          <label>Partita IVA:</label>
          <input
            type="text"
            formControlName="partitaIva"
            class="form-control"
            [readonly]="!editMode"
          />
        </div>

        <!-- Sito Web -->
        <div class="form-group">
          <label>Sito Web:</label>
          <input
            type="text"
            formControlName="sitoWeb"
            class="form-control"
            [readonly]="!editMode"
          />
        </div>

        <!-- Pulsanti -->
        <div class="mt-3">
          <!-- Se in modalità edit e proprietario, mostra Salva e Annulla -->
          <div *ngIf="editMode && isOwner">
            <button
              type="submit"
              class="btn btn-success"
              [disabled]="!resellerForm.valid"
            >
              Salva
            </button>
            <button
              type="button"
              class="btn btn-secondary ml-2"
              (click)="toggleEdit()"
            >
              Annulla
            </button>
          </div>
          <!-- Se non in modalità edit e se l'utente è il proprietario, mostra il pulsante Modifica -->
          <div *ngIf="!editMode && isOwner">
            <button
              type="button"
              class="btn btn-primary"
              (click)="toggleEdit()"
            >
              Modifica i tuoi dati
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Sezione per caricare un nuovo prodotto, visibile solo al rivenditore -->
<div class="m-5" *ngIf="userRole === 'ROLE_RESELLER'">
  <button class="btn btn-primary" routerLink="/new-autopart">Carica</button>
</div>

<!-- Sezione per visualizzare gli articoli (autoparts) -->
<h2 class="mt-5">Prodotti del rivenditore</h2>
<div class="row">
  <div *ngFor="let autopart of autoparts" class="col-12 col-md-6 col-lg-3 mb-4">
    <div class="card h-100">
      <img
        [src]="imgUrl + autopart.immagine || 'assets/placeholder.png'"
        class="card-img-top img-fluid p-3 h-100"
        alt="{{ autopart.nome }}"
      />
      <div class="card-body">
        <h5 class="card-title">{{ autopart.nome }}</h5>
        <p class="card-text">
          Prezzo: {{ autopart.prezzi[0].importo | currency : "EUR" }}
        </p>
        <p class="card-text">Codice OE: {{ autopart.codiceOe }}</p>
      </div>
      <div class="card-footer">
        <button
          *ngIf="userRole === 'ROLE_RESELLER' && isOwner"
          class="btn btn-warning btn-sm me-2"
          [routerLink]="['/reseller/edit-autopart', autopart.id]"
        >
          Modifica
        </button>
        <button
          *ngIf="userRole === 'ROLE_RESELLER' && isOwner"
          class="btn btn-danger btn-sm"
          (click)="deleteAutopart(autopart.id)"
        >
          Elimina
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Sezione per lasciare una valutazione (visibile solo a utenti con ruolo USER) -->
<div class="m-5" *ngIf="userRole !== 'ROLE_RESELLER'">
  <h3>Lascia la tua valutazione</h3>
  <form (ngSubmit)="submitRating()">
    <div class="form-group">
      <label for="ratingSelect">Voto (1-5):</label>
      <select
        id="ratingSelect"
        [(ngModel)]="newRating.rating"
        name="rating"
        required
        class="form-control"
      >
        <option *ngFor="let r of [1, 2, 3, 4, 5]" [value]="r">{{ r }}</option>
      </select>
    </div>
    <div class="form-group mt-2">
      <label for="ratingComment">Commento (opzionale):</label>
      <textarea
        id="ratingComment"
        [(ngModel)]="newRating.comment"
        name="comment"
        class="form-control"
        rows="3"
      ></textarea>
    </div>
    <button type="submit" class="btn btn-primary mt-3">
      Invia valutazione
    </button>
  </form>
</div>
